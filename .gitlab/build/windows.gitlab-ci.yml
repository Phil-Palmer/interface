interface windows:
    stage: build
    tags:
        - windows

    extends: .production

    variables:
        BUILD_TYPE: Release
        RELEASE_TYPE: PRODUCTION
        STABLE_BUILD: 1

        RELEASE_NUMBER: $CI_COMMIT_TAG

        #HIFI_QT_BASE: $CI_PROJECT_DIR/build/HIFI_QT
        #HIFI_VCPKG_BASE: $CI_PROJECT_DIR/build/HIFI_VCPKG
        HIFI_QT_BASE: C:\HIFI_QT
        HIFI_VCPKG_BASE: C:\HIFI_VCPKG

        CL: /MP # might make vcpkg build faster (but doesn't)

    # cache is intensly slow on windows ntfs
    # cache:
    #     paths:
    #         - build/HIFI_QT
    #         - build/HIFI_VCPKG

    script:
        - mkdir build
        - cd build

        # -DCLIENT_ONLY:BOOLEAN=TRUE
        - cmake -DCMAKE_BUILD_TYPE=Release -A x64 ..
        - cmake --build . --parallel --config Release --target interface

        - cd interface\Release
        - del interface.exp
        - del interface.lib
        - del interface.pdb

    artifacts:
        expire_in: 1 day
        paths:
            - build/interface/Release

launcher windows:
    stage: package
    tags:
        - windows

    extends: .production

    dependencies:
        - interface windows

    variables:
        CSC_LINK: C:\Users\maki\tivoli-cloud-vr.pfx
        # CSC_KEY_PASSWORD

    script:
        # - Remove-Item -Recurse -Force -ErrorAction Ignore launcher # just incase
        - git clone https://gitlab-ci-token:$CI_JOB_TOKEN@git.tivolicloud.com/tivolicloud-private/launcher
        - mv build/interface/Release launcher/interface

        # TODO: this needs changing
        - cd launcher/.gitlab
        - yarn install
        # needs CI_COMMIT_TAG
        - node prepare.js
        - cd ..

        - yarn install
        - yarn build
        - yarn package

    artifacts:
        expire_in: 1 day
        paths:
            - launcher/dist/*.exe
            - launcher/dist/*.blockmap
            - launcher/dist/*.yml
